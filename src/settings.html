<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            display: flex;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f0f2f5;
        }
        .container {
            display: flex;
            width: 100%;
            gap: 20px;
        }
        .panel {
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .left-panel {
            flex: 0 0 300px;
        }
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .group-box {
            margin-bottom: 20px;
        }
        .group-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #e8e8e8;
            padding-bottom: 10px;
            font-size: 16px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="text"] {
            width: calc(100% - 20px);
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        input[readonly] {
            background-color: #f9f9f9;
        }
        button {
            padding: 10px 15px;
            border: none;
            background-color: #1890ff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        textarea {
            width: calc(100% - 20px);
            height: 100px;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .user-info label {
            color: red;
        }
        .ad-placeholder {
            width: 100%;
            height: 450px;
            background-color: #e9e9e9;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
        }
        .bottom-row {
            display: flex;
            gap: 20px;
        }
        .bottom-row > div {
            flex: 1;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }
        #tdx-path.invalid { color: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel left-panel">
            <div class="group-box">
                <h3>操作与信息</h3>
                <label for="machine-code">您的机器码:</label>
                <input type="text" id="machine-code" readonly>
                <button id="copy-machine-code">复制机器码</button>
            </div>
            <div class="group-box user-info">
                <label for="user-type">用户类型:</label>
                <input type="text" id="user-type" readonly>
                <label for="expiry-date">有效期:</label>
                <input type="text" id="expiry-date" readonly>
            </div>
            <div class="group-box">
                <label>数据更新设置:</label>
                <button id="manual-update">手动更新数据</button>
            </div>
            <div class="group-box">
                <label for="tdx-path">通达信安装目录:</label>
                <input type="text" id="tdx-path" readonly>
                <button id="set-tdx-path">手动设置目录</button>
            </div>
            <div class="group-box">
                <h3>日志</h3>
                <textarea id="log-display" readonly></textarea>
            </div>
        </div>
        <div class="right-panel">
            <div class="ad-placeholder" id="ad-display">
                <img id="ad-image" alt="广告位" style="max-width: 100%; max-height: 450px; border-radius: 8px; display: none;" />
                <span id="ad-fallback">广告位</span>
            </div>
            <div class="bottom-row">
                <div class="panel">
                    <h3>公告栏</h3>
                    <textarea id="notice-box" readonly></textarea>
                </div>
                <div class="panel">
                    <h3>作者联系方式</h3>
                    <textarea id="author-contact" readonly>QQ: 123456aaaaaaa78
Email: author@example.com</textarea>
                </div>
            </div>
        </div>
    </div>
    <script>
        const invoke = window.__TAURI__?.core?.invoke
            ? window.__TAURI__.core.invoke
            : ((cmd, args) => Promise.reject('Tauri 未可用'));

        function showToast(message) {
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 加载并显示通达信路径配置
            invoke('ensure_tdx_path_configured')
                .then(status => {
                    const el = document.getElementById('tdx-path');
                    el.value = status.path || '';
                    if (!status.is_valid) {
                        el.classList.add('invalid');
                        if (status.error_msg) showToast(status.error_msg);
                    } else {
                        el.classList.remove('invalid');
                    }
                })
                .catch(() => {
                    const el = document.getElementById('tdx-path');
                    el.value = 'C\\new_tdx';
                    el.classList.add('invalid');
                });
            // 填充 AUTH 信息
            invoke('get_auth_info')
                .then(info => {
                    document.getElementById('machine-code').value = info.machine_code || '';
                    document.getElementById('user-type').value = info.user_type_display || '';
                    document.getElementById('expiry-date').value = info.auth_end || '';
                })
                .catch(error => {
                    console.error('加载认证信息失败: ', error);
                });

            // 加载公告
            invoke('get_announcement')
                .then(data => {
                    const text = `标题: ${data.title}\n\n${data.content}`;
                    document.getElementById('notice-box').value = text;
                })
                .catch(() => {
                    document.getElementById('notice-box').value = '找不到文件 announcement.ini';
                });

            // 加载广告图片
            invoke('get_advertisement_data_url')
                .then(url => {
                    const img = document.getElementById('ad-image');
                    const fallback = document.getElementById('ad-fallback');
                    img.src = url;
                    img.style.display = 'block';
                    fallback.style.display = 'none';
                })
                .catch(() => {
                    const fallback = document.getElementById('ad-fallback');
                    fallback.textContent = '找不到文件 advertisement.png';
                });

            // 加载同步日志
            invoke('get_sync_log')
                .then(text => {
                    const el = document.getElementById('log-display');
                    el.value = text || '';
                })
                .catch(err => {
                    const el = document.getElementById('log-display');
                    el.value = (typeof err === 'string' && err.includes('无法读取日志文件'))
                        ? err
                        : '错误: 无法读取日志文件\nresources/sync_log.ini';
                });
        });

        // In a real application, you would use Tauri's API
        // to populate these fields and handle button clicks.
        document.getElementById('copy-machine-code').addEventListener('click', () => {
            const machineCode = document.getElementById('machine-code').value || '';
            navigator.clipboard.writeText(machineCode)
                .then(() => {
                    const msg = machineCode ? `${machineCode} 已复制到剪贴板` : '机器码已复制到剪贴板';
                    showToast(msg);
                })
                .catch(() => showToast('复制失败，请重试'));
        });

        // 手动设置通达信安装目录
        document.getElementById('set-tdx-path').addEventListener('click', async () => {
            const current = document.getElementById('tdx-path').value || 'C\\new_tdx';
            let selected = null;
            if (window.__TAURI__?.dialog?.open) {
                try {
                    selected = await window.__TAURI__.dialog.open({ directory: true, multiple: false, defaultPath: current });
                } catch (e) { /* 忽略对话框异常 */ }
            }
            if (!selected) {
                selected = window.prompt('请输入新的通达信安装目录:', current);
            }
            if (!selected) return;

            invoke('set_new_tdx_path', { new_path: selected })
                .then(status => {
                    const el = document.getElementById('tdx-path');
                    el.value = status.path || '';
                    if (!status.is_valid) {
                        el.classList.add('invalid');
                        if (status.error_msg) alert(status.error_msg);
                    } else {
                        el.classList.remove('invalid');
                        showToast('通达信目录已更新！');
                    }
                })
                .catch(() => alert('设置失败'));
        });

        // 可选：点击广告打开链接（如需）
        // document.getElementById('ad-display').addEventListener('click', () => {
        //     alert("打开链接: https://www.baidu.com");
        // });
    </script>
</body>
</html>
